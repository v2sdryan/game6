<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>角鬥士 vs 猛獸</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{width:100%;height:100%;overflow:hidden;background:#0a0a18;font-family:-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif}
    canvas{display:block}
    #ui{position:fixed;top:0;left:0;width:100%;z-index:10;padding:6px 10px;padding-top:max(6px,env(safe-area-inset-top));pointer-events:none}
    .hp-row{display:flex;gap:8px}.hp-group{flex:1}
    .hp-label{color:#ccc;font-size:10px;margin-bottom:2px;font-weight:bold}
    .hp-label.player{color:#ff6644}.hp-label.beast{color:#ffcc22}
    .hp-bar-bg{width:100%;height:12px;background:#222;border-radius:6px;border:1.5px solid #444;overflow:hidden}
    .hp-bar{height:100%;border-radius:5px;transition:width 0.3s}
    .hp-bar.player{background:linear-gradient(#ff6644,#cc3322)}.hp-bar.beast{background:linear-gradient(#ffcc22,#cc9900)}
    #wave-display{position:fixed;top:36px;top:calc(36px + env(safe-area-inset-top));left:50%;transform:translateX(-50%);color:#e8c840;font-size:14px;font-weight:bold;z-index:10;pointer-events:none}
    #weapon-display{position:fixed;top:53px;top:calc(53px + env(safe-area-inset-top));left:50%;transform:translateX(-50%);color:#aaa;font-size:11px;z-index:10;pointer-events:none}

    /* MENU */
    #menu{position:fixed;inset:0;z-index:100;background:rgba(10,10,24,0.97);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px}
    #menu.hidden{display:none}
    #menu h1{color:#e8c840;font-size:min(34px,8vw);text-shadow:0 0 15px rgba(232,200,64,0.3)}
    #menu p{color:#888;font-size:12px}
    .menu-btn{display:block;padding:18px 56px;font-size:20px;font-weight:bold;background:#cc6633;color:#fff;border:none;border-radius:14px;min-height:60px;min-width:240px;cursor:pointer;touch-action:manipulation;-webkit-appearance:none}
    .menu-btn:active{background:#ee8844;transform:scale(0.97)}
    .music-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 28px;font-size:16px;background:rgba(255,255,255,0.1);color:#ccc;border:1.5px solid #555;border-radius:10px;cursor:pointer;touch-action:manipulation;-webkit-appearance:none;margin-top:6px}
    .music-btn:active{background:rgba(255,255,255,0.2)}
    .music-btn.off{border-color:#883333;color:#883333}
    .hint{color:#555;font-size:10px;text-align:center;line-height:1.6;margin-top:8px}

    /* TOP BUTTONS */
    .top-btns{position:fixed;top:6px;top:max(6px,env(safe-area-inset-top));right:10px;z-index:50;display:flex;gap:5px}
    .top-btns button{width:40px;height:40px;border-radius:50%;border:1.5px solid #555;background:rgba(30,30,30,0.85);color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;touch-action:manipulation;-webkit-appearance:none}
    .top-btns button.off{border-color:#883333;color:#883333}

    /* OVERLAY */
    #overlay{position:fixed;inset:0;display:none;z-index:90;background:rgba(0,0,0,0.88);flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:20px}
    #overlay.show{display:flex}
    #overlay h1{font-size:min(38px,10vw)}
    #overlay h1.win{color:#ffd700}#overlay h1.lose{color:#cc3333}
    #overlay p{color:#aaa;font-size:13px}
    .overlay-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .overlay-btns button{padding:14px 28px;font-size:16px;font-weight:bold;color:#fff;border:none;border-radius:10px;min-height:50px;cursor:pointer;touch-action:manipulation;-webkit-appearance:none}
    .overlay-btns .primary{background:#cc6633}.overlay-btns .secondary{background:#555;font-size:15px}

    /* JOYSTICK */
    #joystick-zone{position:fixed;left:0;bottom:0;width:45%;height:50%;z-index:14}
    #joystick-base{position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.15);display:none;pointer-events:none}
    #joystick-knob{position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.25);border:2px solid rgba(255,255,255,0.4);display:none;pointer-events:none}

    /* ACTION BUTTONS */
    #action-zone{position:fixed;right:10px;bottom:10px;bottom:calc(10px + env(safe-area-inset-bottom));z-index:15;display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .m-btn{border-radius:50%;border:2.5px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#fff;display:flex;align-items:center;justify-content:center;user-select:none;-webkit-user-select:none;font-weight:bold;cursor:pointer;touch-action:manipulation;-webkit-appearance:none}
    .m-btn:active,.m-btn.pressed{background:rgba(255,255,255,0.35)}
    .m-btn.atk{width:88px;height:88px;font-size:16px;border-color:rgba(255,100,50,0.5);background:rgba(255,100,50,0.15)}
    .m-btn.atk:active,.m-btn.atk.pressed{background:rgba(255,100,50,0.4)}
    .m-btn.med{width:64px;height:64px;font-size:13px}
    .m-btn.sm{width:52px;height:52px;font-size:11px}
    .action-row{display:flex;gap:8px;align-items:center}

    #controls-hint{position:fixed;bottom:6px;left:50%;transform:translateX(-50%);color:#333;font-size:9px;z-index:10;pointer-events:none}
    #error-log{position:fixed;bottom:40px;left:10px;color:#ff4444;font-size:10px;z-index:999;pointer-events:none;max-width:80%}
    @media(pointer:coarse){#controls-hint{display:none}}
    @media(pointer:fine){#joystick-zone{display:none}#action-zone{opacity:0.25}#action-zone:hover{opacity:1}}
  </style>
</head>
<body>
  <!-- MENU -->
  <div id="menu">
    <h1>角鬥士 vs 猛獸</h1>
    <p>羅馬競技場 3D 生存戰</p>
    <button class="menu-btn" id="start-btn">開始遊戲</button>
    <button class="music-btn" id="menu-music-btn">♫ 背景音樂: 開</button>
    <div class="hint">左邊拖動移動 | 右邊按鈕攻擊<br>雙指拖動旋轉鏡頭</div>
  </div>

  <!-- HUD -->
  <div id="ui">
    <div class="hp-row">
      <div class="hp-group"><div class="hp-label player">士兵</div><div class="hp-bar-bg"><div id="player-hp" class="hp-bar player" style="width:100%"></div></div></div>
      <div class="hp-group"><div class="hp-label beast">猛獸</div><div class="hp-bar-bg"><div id="beast-hp" class="hp-bar beast" style="width:100%"></div></div></div>
    </div>
  </div>
  <div id="wave-display">第 1 波</div>
  <div id="weapon-display">武器：劍</div>
  <div class="top-btns">
    <button id="btn-sound" title="音樂">♫</button>
    <button id="btn-menu" title="主頁" style="font-size:20px">⌂</button>
  </div>

  <!-- Game Over -->
  <div id="overlay">
    <h1 id="overlay-title"></h1>
    <p id="overlay-sub"></p>
    <div class="overlay-btns">
      <button class="primary" id="btn-restart">重新開始</button>
      <button class="secondary" id="btn-back">返回主頁</button>
    </div>
  </div>

  <!-- Joystick -->
  <div id="joystick-zone"><div id="joystick-base"></div><div id="joystick-knob"></div></div>

  <!-- Action buttons -->
  <div id="action-zone">
    <div class="action-row">
      <button class="m-btn sm" id="btn-weapon">換武</button>
      <button class="m-btn med" id="btn-jump">跳躍</button>
    </div>
    <button class="m-btn atk" id="btn-attack">攻擊</button>
  </div>

  <div id="controls-hint">WASD 移動 | 空格 攻擊 | Q 武器 | 右鍵旋轉鏡頭</div>
  <div id="error-log"></div>

  <script>
    // ===== ALL BUTTON LOGIC HERE (no module dependency) =====
    window.GAME = { started: false, musicOn: true };

    // Background music (loads immediately)
    var bgm = new Audio('./Legions_of_the_Arena.mp3');
    bgm.loop = true; bgm.volume = 0.3;

    function toggleMusic() {
      window.GAME.musicOn = !window.GAME.musicOn;
      if (window.GAME.musicOn) {
        bgm.play().catch(function(){});
        document.getElementById('btn-sound').textContent = '♫';
        document.getElementById('btn-sound').classList.remove('off');
        document.getElementById('menu-music-btn').textContent = '♫ 背景音樂: 開';
        document.getElementById('menu-music-btn').classList.remove('off');
      } else {
        bgm.pause();
        document.getElementById('btn-sound').textContent = '✕';
        document.getElementById('btn-sound').classList.add('off');
        document.getElementById('menu-music-btn').textContent = '✕ 背景音樂: 關';
        document.getElementById('menu-music-btn').classList.add('off');
      }
    }

    function startGame() {
      document.getElementById('menu').classList.add('hidden');
      window.GAME.started = true;
      // Start music on first interaction
      if (window.GAME.musicOn) bgm.play().catch(function(){});
      // Notify module if loaded
      if (window._onStart) window._onStart();
    }

    function backToMenu() {
      document.getElementById('overlay').classList.remove('show');
      document.getElementById('menu').classList.remove('hidden');
      window.GAME.started = false;
      if (window._onMenu) window._onMenu();
    }

    function restartGame() {
      document.getElementById('overlay').classList.remove('show');
      window.GAME.started = true;
      if (window._onRestart) window._onRestart();
    }

    // Wire buttons with both click and touchstart
    function wire(id, fn) {
      var el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('touchstart', function(e) { e.preventDefault(); e.stopPropagation(); fn(); }, { passive: false });
      el.addEventListener('click', function(e) { e.preventDefault(); fn(); });
    }
    wire('start-btn', startGame);
    wire('menu-music-btn', toggleMusic);
    wire('btn-sound', toggleMusic);
    wire('btn-menu', backToMenu);
    wire('btn-restart', restartGame);
    wire('btn-back', backToMenu);

    // Error logging for debug
    window.onerror = function(msg, url, line) {
      document.getElementById('error-log').textContent = msg + ' (line ' + line + ')';
    };
  </script>
  <script type="module" src="/src/main.js"></script>
</body>
</html>
